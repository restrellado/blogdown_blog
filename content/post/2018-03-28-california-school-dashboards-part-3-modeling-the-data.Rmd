---
title: 'California School Dashboards Part 3: Modeling the Data '
author: Ryan Estrellado
date: '2018-03-28'
slug: california-school-dashboards-part-3-modeling-the-data
categories: []
tags:
  - school_data
  - tidyverse 
draft: TRUE
---

```{r echo=FALSE, message=FALSE}
library(tidyverse) 
library(modelr) 
library(knitr) 
library(spedtools)
```

```{r echo=FALSE}
opts_chunk$set(echo = FALSE, message = FALSE)
```

```{r}
# Read data 
urls <- c(
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_1.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_2.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_3.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_4.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_5.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_6.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_7.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_8.tsv", 
  "https://raw.githubusercontent.com/restrellado/data_for_blog/master/dashboard_model_data/district_9.tsv"
) 

all_files <- urls %>% 
  map(., read_tsv) %>% 
  set_names(., nm = map_chr(., ~unique(.$districtname)))
```

If we plot the distance from three score of math on the x-axis and the distance 
from three score of English language arts for each school's subgroup in 
`district_1`, we see that there is a pretty clear linear pattern. 

```{r}
all_files[[1]] %>% 
  # Remove school level datapoints 
  filter(!is.na(schoolname)) %>%
  ggplot(aes(x = currstatus_math, y = currstatus_ela)) + 
  geom_point() + 
  geom_smooth(method = "lm") +
  labs(title = "Distance from Three: Math vs. English Language Arts", 
       x = "Math Dist from Three", y = "ELA Dist from Three")
```

The line drawn through the plot is the model fit. That means that it goes through 
the plot in a straight line to best follow the relationship between the math 
distance of three and the English language arts distance from three in this 
dataset. This relationship is quantified by the model, but we won't go into that 
here because we're more interested in how well this model predicted scores for 
each school's subgroup. We're interested in looking at the differences between 
predictions and actual data points and how that looks similar or different for 
each school's subgroups. 

In order to compare this model fit to all nine of our districts, I arranged the 
data so that each row was a district and their dataset. I then fit a linear model 
to each district and calculated the differences between the predicted values 
and actual values. These differences are stored in a column called `resid` 
(short for [residuals](https://en.wikipedia.org/wiki/Errors_and_residuals)). 

```{r}
comb <- all_files %>% 
  bind_rows() %>% 
  # Remove district level observations, only include subgroups
  filter(!is.na(schoolname), studentgroup != "ALL") %>% 
  mutate(studentgroup = convert_subgroup(studentgroup)) %>% 
  # Nest datasets by district
  group_by(districtname) %>% 
  nest() 
```

Here is some of the code for getting that done. Feel free to skip to the plots if 
you want to start examing the results. 

I used a function for the linear model so I can apply it to all nine datasets 
using the `purrr` package. 

```{r echo=TRUE}
dist_mod <- function(d) {
  lm(currstatus_ela ~ currstatus_math, data = d)
}
```

Next I used `modelr::add_residuals` to add the residuals. 

```{r echo=TRUE}
mods <- comb %>% 
  mutate(model = map(data, dist_mod), 
         resids = map2(data, model, add_residuals)) 
```

Finally I used `dplyr:unnest` to open up the dataset so that each residual 
value had it's own row. 

```{r echo=TRUE}
resids <- mods %>% 
  unnest(resids)
```

**A note on missing values** 

**The original dataset did not include distance from three scores for any subgroup that had less than 11 students. This is a typical practice with education data and is usually done to maintain student confidentiality. Consdquently, there is a pretty sizeable amount of subgroups that are missing distance from three scores.**

```{r results='hide'}
resids %>% map(~sum(is.na(.)))
```

```{r results='hide'}
resids %>% 
  filter(is.na(currstatus_ela) | is.na(currstatus_math))
```

# Visualizing the Differences Between Prediction and Actual Datapoints 

If we create a plot that has the distance from three scores (our predictor) in 
the x-axis and the residuals (a.k.a., difference between predicted and actual 
values in the y-axis) for each district, we get the following: 

```{r echo=TRUE}
ggplot(data = resids, aes(x = currstatus_math, y = resid)) + 
  geom_point(alpha = .25) + 
  facet_wrap(~ districtname) + 
  labs(title = "Residuals Across Math Distance From Three Scores", 
       x = "Math: Distance From Three", 
       y = "Residuals")
```

```{r echo=TRUE}
ggplot(data = resids, aes(x = currstatus_math, y = resid, color = studentgroup)) + 
  geom_point(alpha = .25) + 
  facet_wrap(~ districtname) + 
  labs(title = "Residuals Across Math Distance From Three Scores", 
       x = "Math: Distance From Three", 
       y = "Residuals")
```


[Definition of EL and ELO](https://www.cde.ca.gov/ta/ac/cm/documents/dashboardguidespring17.pdf) 

```{r echo=TRUE}
resids %>% 
  mutate(elo = ifelse(studentgroup == "English Learners Only", "ELO", "Not ELO")) %>%
  ggplot(data = ., aes(x = currstatus_math, y = resid, color = elo)) + 
  geom_point(alpha = .5) + 
  facet_wrap(~ districtname) +
  labs(title = "Residuals Across Math Distance From Three Scores", 
       x = "Math: Distance From Three", 
       y = "Residuals", 
       color = "")
```

When the residuals are negative, the actual datapoint was lower than what the 
model thought it should be. 